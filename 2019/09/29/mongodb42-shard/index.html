<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Mongodb4.2.0 副本集 + 分片 + 自动运维脚本 | DIUDIU 小菜鸟</title><meta name="keywords" content="mongo,shard"><meta name="author" content="景帅"><meta name="copyright" content="景帅"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="MongoDB4.2.0分片+副本集集群搭建 现根据需求在平台搭建一个有16台主机的MongoDB集群，主要以下关键点：  根据最新版本MongoDB推荐，配置文件采用yaml方式来配置 一共16台服务器，即16个节点。对数据集进行分片，共分8个shard,3个config节点,5个路由节点   环境准备 服务器规划： 123456789101112131415161718192021222324">
<meta property="og:type" content="article">
<meta property="og:title" content="Mongodb4.2.0 副本集 + 分片 + 自动运维脚本">
<meta property="og:url" content="http://www.jsledd.cn/2019/09/29/mongodb42-shard/">
<meta property="og:site_name" content="DIUDIU 小菜鸟">
<meta property="og:description" content="MongoDB4.2.0分片+副本集集群搭建 现根据需求在平台搭建一个有16台主机的MongoDB集群，主要以下关键点：  根据最新版本MongoDB推荐，配置文件采用yaml方式来配置 一共16台服务器，即16个节点。对数据集进行分片，共分8个shard,3个config节点,5个路由节点   环境准备 服务器规划： 123456789101112131415161718192021222324">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.jsledd.cn/images/11.jpg">
<meta property="article:published_time" content="2019-09-29T07:46:25.000Z">
<meta property="article:modified_time" content="2021-01-08T09:44:32.646Z">
<meta property="article:author" content="景帅">
<meta property="article:tag" content="mongo">
<meta property="article:tag" content="shard">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.jsledd.cn/images/11.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.jsledd.cn/2019/09/29/mongodb42-shard/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?97afb665c94e0e38fa62f5e1ea0c5c68";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 景帅","link":"链接: ","source":"来源: DIUDIU 小菜鸟","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-01-08 17:44:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD"><i class="fa-fw fas fa-robot - 机器学习"></i><span> 人工智能</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95"><i class="fa-fw fas fa-tags - 数组"></i><span> 数据结构与算法</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE"><i class="fa-fw fas fa-folder-open - hadoop"></i><span> 大数据</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93"><i class="fa-fw fas fa-folder-open - mongo"></i><span> 数据库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%8A%80%E5%B7%A7"><i class="fa-fw fas fa-folder-open - java"></i><span> 开发语言与技巧</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li></ul></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/11.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">DIUDIU 小菜鸟</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD"><i class="fa-fw fas fa-robot - 机器学习"></i><span> 人工智能</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95"><i class="fa-fw fas fa-tags - 数组"></i><span> 数据结构与算法</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE"><i class="fa-fw fas fa-folder-open - hadoop"></i><span> 大数据</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93"><i class="fa-fw fas fa-folder-open - mongo"></i><span> 数据库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%8A%80%E5%B7%A7"><i class="fa-fw fas fa-folder-open - java"></i><span> 开发语言与技巧</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mongodb4.2.0 副本集 + 分片 + 自动运维脚本</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-09-29T07:46:25.000Z" title="发表于 2019-09-29 15:46:25">2019-09-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-08T09:44:32.646Z" title="更新于 2021-01-08 17:44:32">2021-01-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/">mongodb</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>MongoDB4.2.0分片+副本集集群搭建</p>
<p>现根据需求在平台搭建一个有16台主机的MongoDB集群，主要以下关键点：</p>
<ul>
<li>根据最新版本MongoDB推荐，配置文件采用yaml方式来配置</li>
<li>一共16台服务器，即16个节点。对数据集进行分片，共分8个shard,3个config节点,5个路由节点</li>
</ul>
<h3 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h3>
<p>服务器规划：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">CentOS Linux release 7.6.1810</span><br><span class="line">MongoDB 4.2.0</span><br><span class="line">mongodb-linux-x86_64-4.2.0.tgz 二进制包</span><br><span class="line">shard分片主机：</span><br><span class="line">    shard1: </span><br><span class="line">    	IP:cache05:27001(主)</span><br><span class="line">    	IP:cache06:27001(备)</span><br><span class="line">    	IP:cache08:27001(仲)</span><br><span class="line">    shard2: </span><br><span class="line">    	IP:cache07:27002(主)</span><br><span class="line">    	IP:cache08:27002(备)</span><br><span class="line">    	IP:cache06:27002(仲)</span><br><span class="line">    shard3: </span><br><span class="line">       	IP:cache09:27003(主)</span><br><span class="line">     	IP:cache10:27003(备)</span><br><span class="line">    	IP:cache11:27003(仲)</span><br><span class="line">    shard4: </span><br><span class="line">       	IP:cache11:27004(主)</span><br><span class="line">     	IP:cache12:27004(备)</span><br><span class="line">    	IP:cache10:27004(仲)</span><br><span class="line">    shard5: </span><br><span class="line">    	IP:cache13:27005(主)</span><br><span class="line">    	IP:cache14:27005(备)</span><br><span class="line">    	IP:cache16:27005(仲)</span><br><span class="line">    shard6: </span><br><span class="line">    	IP:cache15:27006(主)</span><br><span class="line">    	IP:cache16:27006(备)</span><br><span class="line">    	IP:cache14:27007(仲)</span><br><span class="line">    shard7: </span><br><span class="line">       	IP:cache17:27007(主)</span><br><span class="line">     	IP:cache18:27007(备)</span><br><span class="line">    	IP:cache20:27008(仲)</span><br><span class="line">    shard8: </span><br><span class="line">       	IP:cache19:27008(主)</span><br><span class="line">     	IP:cache20:27008(备)</span><br><span class="line">    	IP:cache18:27008(仲)</span><br><span class="line">configsrv主机：</span><br><span class="line">    	IP:cache06:28000</span><br><span class="line">    	IP:cache08:28000</span><br><span class="line">    	IP:cache10:28000</span><br><span class="line">    	</span><br><span class="line">Route(mongods)主机：</span><br><span class="line">        IP:cache12:29000</span><br><span class="line">        IP:cache14:29000</span><br><span class="line">        IP:cache16:29000</span><br><span class="line">        IP:cache18:29000</span><br><span class="line">        IP:cache20:29000</span><br></pre></td></tr></table></figure>
<h3 id="创建用户"><a class="markdownIt-Anchor" href="#创建用户"></a> 创建用户</h3>
<p>创建用户mongod，用于安装使用MongoDB 数据库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在任意主机 上执行命令,创建用户</span><br><span class="line">	ssh root@cache05 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache06 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache07 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache08 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache09 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache10 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache11 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache12 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache13 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache14 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache15 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache16 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache17 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache18 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache19 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br><span class="line">	ssh root@cache20 &quot;useradd -d /mongod mongod &amp;&amp; passwd mongod&quot;</span><br></pre></td></tr></table></figure>
<h3 id="免密登陆"><a class="markdownIt-Anchor" href="#免密登陆"></a> 免密登陆</h3>
<p>我们选取 cache20 作为集群的管理机器，做免密的目的是管理其他节点时，不需要再输入密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#cache20  上执行</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache20</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache19</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache18</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache17</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache16</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache15</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache14</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache13</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache12</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache11</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache10</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache09</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache08</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache07</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache06</span><br><span class="line">ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub cache05</span><br></pre></td></tr></table></figure>
<h3 id="mongodb安装"><a class="markdownIt-Anchor" href="#mongodb安装"></a> MongoDB安装</h3>
<p>安装并配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">将安装包mongodb-linux-x86_64-4.2.0.tgz 拷贝到每台机器的家目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在主机 cache20 上执行命令</span></span><br><span class="line">	ssh mongod@cache05 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache06 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache07 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache08 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache09 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache10 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache11 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache12 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache13 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache14 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache15 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache16 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache17 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache18 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache19 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">	ssh mongod@cache20 &quot;mkdir -p /mongod/Tools/ &amp;&amp; tar -zvxf mongodb-linux-x86_64-4.2.0.tgz -C /mongod/Tools/ &amp;&amp; mv /mongod/Tools/mongodb-linux-x86_64-4.2.0 /mongod/Tools/mongodb&quot;</span><br><span class="line">配置环境变量</span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash">加入以下内容</span></span><br><span class="line">export PATH=/mongod/Tools/mongodb/bin:$PATH</span><br><span class="line">立即生效</span><br><span class="line">source ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash">根据要求 数据文件 放在 /data 下面</span></span><br><span class="line">ssh root@cache20 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache19 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache18 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache17 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache16 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache15 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache14 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache13 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache12 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache11 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache10 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache09 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache08 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache07 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache06 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br><span class="line">ssh root@cache05 &quot;mkdir /data/mongodata &amp;&amp; chown mongod:mongod /data/mongodata&quot;</span><br></pre></td></tr></table></figure>
<h3 id="规划目录结构"><a class="markdownIt-Anchor" href="#规划目录结构"></a> 规划目录结构</h3>
<p>规划相关的目录结构，并且新建文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">mongo服务通过配置文件启动,存放配置文件目录/mongod/Tools/mongodb/conf/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">存放日志、进程管理信息的目录/mongod/Tools/mongodb/<span class="built_in">log</span>/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">数据存放目录/data/mongodata</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在 cache20 上执行命令,创建文件夹</span></span><br><span class="line">	ssh mongod@cache05 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard1&quot;</span><br><span class="line">	ssh mongod@cache06 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/configsrv /data/mongodata/shard1 /data/mongodata/shard2&quot;</span><br><span class="line">	ssh mongod@cache07 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard2&quot;</span><br><span class="line">	ssh mongod@cache08 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/configsrv /data/mongodata/shard2 /data/mongodata/shard1&quot;</span><br><span class="line">	ssh mongod@cache09 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard3&quot;</span><br><span class="line">	ssh mongod@cache10 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/configsrv /data/mongodata/shard3 /data/mongodata/shard4&quot;</span><br><span class="line">	ssh mongod@cache11 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard4&quot;</span><br><span class="line">	ssh mongod@cache12 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard4 /data/mongodata/shard3&quot;</span><br><span class="line">	ssh mongod@cache13 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard5&quot;</span><br><span class="line">	ssh mongod@cache14 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard5 /data/mongodata/shard6&quot;</span><br><span class="line">	ssh mongod@cache15 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard6&quot;</span><br><span class="line">	ssh mongod@cache16 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard6 /data/mongodata/shard5&quot;</span><br><span class="line">	ssh mongod@cache17 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard7&quot;</span><br><span class="line">	ssh mongod@cache18 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard7 /data/mongodata/shard8&quot;</span><br><span class="line">	ssh mongod@cache19 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard8&quot;</span><br><span class="line">	ssh mongod@cache20 &quot;cd /mongod/Tools/mongodb/ &amp;&amp; mkdir conf log /data/mongodata/shard8 /data/mongodata/shard7&quot;	</span><br></pre></td></tr></table></figure>
<h3 id="集群配置"><a class="markdownIt-Anchor" href="#集群配置"></a> 集群配置</h3>
<h4 id="config-server配置服务器副本集"><a class="markdownIt-Anchor" href="#config-server配置服务器副本集"></a> config server配置服务器（副本集）</h4>
<p>根据服务器规划，在cache06、cache08、cache10上部署三台config server副本集，在该三台服务器上分别添加以下配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/configsvr.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/configsvr.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/configsrv</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/configsrv.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28000</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">configs</span>       </span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">configsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的config server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/configsvr.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 28000 --host cache06</span><br><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> config = &#123;_id : <span class="string">&quot;configs&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache06:28000&quot;</span> &#125;,&#123;_id : 1, host : <span class="string">&quot;cache08:28000&quot;</span> &#125;,&#123;_id : 2, host : <span class="string">&quot;cache10:28000&quot;</span> &#125;]&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">初始化副本集</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">   rs.initiate(config)</span></span><br><span class="line">......</span><br><span class="line"><span class="meta">#</span><span class="bash">查看分区状态</span></span><br><span class="line">configs:SECONDARY&gt; rs.status()</span><br><span class="line">......</span><br><span class="line">configs:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h4 id="shard-server分片服务器副本集"><a class="markdownIt-Anchor" href="#shard-server分片服务器副本集"></a> shard server分片服务器（副本集）</h4>
<h5 id="配置shard1副本集"><a class="markdownIt-Anchor" href="#配置shard1副本集"></a> 配置shard1副本集</h5>
<p>在cache05、cache06、cache08服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard1.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard1.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard1</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard1.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27001</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard1 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard1.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27001 --host cache05</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">   config = &#123;_id : <span class="string">&quot;shard1&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache05:27001&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache06:27001&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache08:27001&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard1:SECONDARY&gt; rs.status();</span><br><span class="line">......</span><br><span class="line">shard1:PRIMARY&gt;  </span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h5 id="配置shard2副本集"><a class="markdownIt-Anchor" href="#配置shard2副本集"></a> 配置shard2副本集</h5>
<p>在cache07、cache08、cache06服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard2.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard2.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard2</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard2.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27002</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard2 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard2.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27002 --host cache07</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> config = &#123;_id : <span class="string">&quot;shard2&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache07:27002&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache08:27002&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache06:27002&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line">......</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">......</span><br><span class="line">shard2:SECONDARY&gt; rs.status();</span><br><span class="line">......</span><br><span class="line">shard2:PRIMARY&gt;  </span><br></pre></td></tr></table></figure>
<h5 id="配置shard3副本集"><a class="markdownIt-Anchor" href="#配置shard3副本集"></a> 配置shard3副本集</h5>
<p>在cache09、cache10、cache12服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard3.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard3.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard3</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard3.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27003</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard3 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard3.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27003 --host cache09</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard3&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache09:27003&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache10:27003&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache12:27003&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h5 id="配置shard4副本集"><a class="markdownIt-Anchor" href="#配置shard4副本集"></a> 配置shard4副本集</h5>
<p>在cache11、cache12、cache10服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard4.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard4.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard4</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard4.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27004</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard4 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard4.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27004 --host cache11</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard4&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache11:27004&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache12:27004&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache10:27004&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h5 id="配置shard5副本集"><a class="markdownIt-Anchor" href="#配置shard5副本集"></a> 配置shard5副本集</h5>
<p>在cache13、cache14、cache16服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard5.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard5.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard5</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard5.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27005</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard5 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard5.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27005 --host cache13</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard5&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache13:27005&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache14:27005&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache16:27005&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h5 id="配置shard6副本集"><a class="markdownIt-Anchor" href="#配置shard6副本集"></a> 配置shard6副本集</h5>
<p>在cache15、cache16、cache14服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard6.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard6.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard6</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard6.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27006</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard6 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard6.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27006 --host cache15</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard6&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache15:27006&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache16:27006&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache14:27006&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h5 id="配置shard7副本集"><a class="markdownIt-Anchor" href="#配置shard7副本集"></a> 配置shard7副本集</h5>
<p>在cache17、cache18、cache20服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard7.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard7.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard7</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard7.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27007</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard7</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard3 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard7.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27007 --host cache17</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard7&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache17:27007&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache18:27007&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache20:27007&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h5 id="配置shard8副本集"><a class="markdownIt-Anchor" href="#配置shard8副本集"></a> 配置shard8副本集</h5>
<p>在cache19、cache20、cache18服务器上做以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/shard8.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/shard8.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodata/shard8</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mongod/Tools/mongodb/log/shard8.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27008</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的shard8 server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongod/Tools/mongodb/conf/shard8.conf</span><br></pre></td></tr></table></figure>
<p>登陆任意一台服务器，初始化副本集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27008 --host cache19</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义副本集配置（键“_id”对应的值必须与配置文件中的replicaction.replSetName一致,priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    config = &#123;_id : <span class="string">&quot;shard8&quot;</span>,members : [&#123;_id : 0, host : <span class="string">&quot;cache19:27008&quot;</span>, priority : 2 &#125;,&#123;_id : 1, host : <span class="string">&quot;cache20:27008&quot;</span>, priority : 1 &#125;,&#123;_id : 2, host : <span class="string">&quot;cache18:27008&quot;</span>, arbiterOnly :<span class="literal">true</span>&#125;]&#125;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> rs.initiate(config)</span></span><br><span class="line">shard3:SECONDARY&gt; rs.status();</span><br><span class="line">shard3:PRIMARY&gt; </span><br></pre></td></tr></table></figure>
<h4 id="mongos-server路由服务器"><a class="markdownIt-Anchor" href="#mongos-server路由服务器"></a> mongos server路由服务器</h4>
<p>根据服务器规划，在cache12、cache14、cache16、cache18、cache20上部署路由服务器，在该5台服务器上分别添加以下配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/mongod/Tools/mongodb/conf/mongos.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mongod/Tools/mongodb/log/mongos.log</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  pidFilePath: /mongod/Tools/mongodb/log/mongos.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">29000</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#监听的配置服务器,只能有1个或者3个 configs为配置服务器的副本集名字</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">   <span class="attr">configDB:</span> <span class="string">configs/cache07:28000,cache08:28000,cache10:28000</span></span><br></pre></td></tr></table></figure>
<p>启动这三台服务器的mongos server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos -f /mongod/Tools/mongodb/conf/mongos.conf</span><br></pre></td></tr></table></figure>
<h4 id="启用分片"><a class="markdownIt-Anchor" href="#启用分片"></a> 启用分片</h4>
<blockquote>
<p>目前已经搭建好配置服务器、数据分片服务器、路由服务器，下面进行分片启用，使得app连接到路由服务器时可以使用分片机制</p>
</blockquote>
<p>登录任意一台mongos</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 29000 --host cache12</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard1/cache05:27001,cache06:27001,cache08:27001&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard2/cache07:27002,cache08:27002,cache06:27002&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard3/cache09:27003,cache10:27003,cache12:27003&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard4/cache11:27004,cache12:27004,cache10:27004&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard5/cache13:27005,cache14:27005,cache16:27005&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard6/cache15:27006,cache16:27006,cache14:27006&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard7/cache17:27007,cache18:27007,cache20:27007&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.addShard(<span class="string">&quot;shard8/cache19:27008,cache20:27008,cache18:27008&quot;</span>)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.status()</span></span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">        &quot;currentVersion&quot; : 6,</span><br><span class="line">        &quot;clusterId&quot; : ObjectId(&quot;5d8048f71f14b07fb9b707e5&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard1&quot;,  &quot;host&quot; : &quot;shard1/cache05:27001,cache06:27001&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard2&quot;,  &quot;host&quot; : &quot;shard2/cache07:27002,cache08:27002&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard3&quot;,  &quot;host&quot; : &quot;shard3/cache09:27003,cache10:27003&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard4&quot;,  &quot;host&quot; : &quot;shard4/cache11:27004,cache12:27004&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard5&quot;,  &quot;host&quot; : &quot;shard5/cache13:27005,cache14:27005&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard6&quot;,  &quot;host&quot; : &quot;shard6/cache15:27006,cache16:27006&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard7&quot;,  &quot;host&quot; : &quot;shard7/cache17:27007,cache18:27007&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard8&quot;,  &quot;host&quot; : &quot;shard8/cache19:27008,cache20:27008&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        &quot;4.2.0&quot; : 5</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: yes</span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds in last 5 attempts:  0</span><br><span class="line">        Migration Results for the last 24 hours: </span><br><span class="line">                No recent migrations</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">                        unique: false</span><br><span class="line">                        balancing: true</span><br><span class="line">                        chunks:</span><br><span class="line">                                shard1  1</span><br><span class="line">                        &#123; &quot;_id&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;_id&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : shard1 Timestamp(1, 0)</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> </span> </span><br></pre></td></tr></table></figure>
<h4 id="测试分片"><a class="markdownIt-Anchor" href="#测试分片"></a> 测试分片</h4>
<p><strong>连接mongodb</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 29000 --host cache20</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###为了展示出效果，修改一下默认的chunksize大小,这里修改为1M</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认的chunksize大小为64M，示例修改命令如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">use config</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db.settings.save( &#123; _id:<span class="string">&quot;chunksize&quot;</span>, value: &lt;sizeInMB&gt; &#125; )</span></span><br><span class="line"></span><br><span class="line">use config</span><br><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: 1 &#125; )</span><br><span class="line"><span class="meta">#</span><span class="bash">为<span class="built_in">test</span>数据库开启分片</span></span><br><span class="line"><span class="meta">#</span><span class="bash">选择一个片键age并指定一个集合mycoll对其进行分片</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.enableSharding(<span class="string">&quot;test&quot;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;ok&quot; : 1,</span><br><span class="line">        &quot;operationTime&quot; : Timestamp(1562670609, 5),</span><br><span class="line">        &quot;$clusterTime&quot; : &#123;</span><br><span class="line">                &quot;clusterTime&quot; : Timestamp(1562670609, 5),</span><br><span class="line">                &quot;signature&quot; : &#123;</span><br><span class="line">                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">                        &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.shardCollection(<span class="string">&quot;test.mycoll&quot;</span>, &#123;<span class="string">&quot;age&quot;</span>: 1&#125;)</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;collectionsharded&quot; : &quot;test.mycoll&quot;,</span><br><span class="line">        &quot;collectionUUID&quot; : UUID(&quot;12a512b1-377a-406b-bde9-36c472fd2e0a&quot;),</span><br><span class="line">        &quot;ok&quot; : 1,</span><br><span class="line">        &quot;operationTime&quot; : Timestamp(1562670619, 14),</span><br><span class="line">        &quot;$clusterTime&quot; : &#123;</span><br><span class="line">                &quot;clusterTime&quot; : Timestamp(1562670619, 14),</span><br><span class="line">                &quot;signature&quot; : &#123;</span><br><span class="line">                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">                        &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">测试分片，写入数据到数据库中</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> use <span class="built_in">test</span></span></span><br><span class="line">switched to db test</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> <span class="keyword">for</span> (i = 1; i &lt;= 100000; i++) db.mycoll.insert(&#123;age:(i%100), name:<span class="string">&quot;bigboss_user&quot;</span>+i, address:i+<span class="string">&quot;, Some Road, beijing&quot;</span>, country:<span class="string">&quot;China&quot;</span>, course:<span class="string">&quot;cousre&quot;</span>+<span class="string">&quot;(i%12)&quot;</span>&#125;)</span></span><br><span class="line">   WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> sh.status()</span></span><br><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">        &quot;currentVersion&quot; : 6,</span><br><span class="line">        &quot;clusterId&quot; : ObjectId(&quot;5d24659a031dddbcb7ec8f7c&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard1&quot;,  &quot;host&quot; : &quot;shard1/hadoop23:27001,hadoop24:27001&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard2&quot;,  &quot;host&quot; : &quot;shard2/hadoop26:27002,hadoop27:27002&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard3&quot;,  &quot;host&quot; : &quot;shard3/hadoop25:27003,hadoop29:27003&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        &quot;4.0.9&quot; : 3</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: yes</span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  yes</span><br><span class="line">        Collections with active migrations: </span><br><span class="line">                test.mycoll2 started at Tue Jul 09 2019 19:18:20 GMT+0800 (CST)</span><br><span class="line">        Failed balancer rounds in last 5 attempts:  0</span><br><span class="line">        Migration Results for the last 24 hours: </span><br><span class="line">                3 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">                        unique: false</span><br><span class="line">                        balancing: true</span><br><span class="line">                        chunks:</span><br><span class="line">                                shard1  1</span><br><span class="line">                        &#123; &quot;_id&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;_id&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : shard1 Timestamp(1, 0) </span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;test&quot;,  &quot;primary&quot; : &quot;shard3&quot;,  &quot;partitioned&quot; : true,  &quot;version&quot; : &#123;  &quot;uuid&quot; : UUID(&quot;871fa9c9-e3e2-42a6-9e6b-0ddd3b69a302&quot;),  &quot;lastMod&quot; : 1 &#125; &#125;</span><br><span class="line">                test.mycoll</span><br><span class="line">                        shard key: &#123; &quot;age&quot; : 1 &#125;</span><br><span class="line">                        unique: false</span><br><span class="line">                        balancing: true</span><br><span class="line">                        chunks:</span><br><span class="line">                                shard1  3</span><br><span class="line">                                shard2  4</span><br><span class="line">                                shard3  2</span><br><span class="line">                        &#123; &quot;age&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;age&quot; : 0 &#125; on : shard2 Timestamp(2, 0) </span><br><span class="line">                        &#123; &quot;age&quot; : 0 &#125; --&gt;&gt; &#123; &quot;age&quot; : 17 &#125; on : shard1 Timestamp(4, 2) </span><br><span class="line">                        &#123; &quot;age&quot; : 17 &#125; --&gt;&gt; &#123; &quot;age&quot; : 34 &#125; on : shard1 Timestamp(4, 3) </span><br><span class="line">                        &#123; &quot;age&quot; : 34 &#125; --&gt;&gt; &#123; &quot;age&quot; : 38 &#125; on : shard1 Timestamp(4, 4) </span><br><span class="line">                        &#123; &quot;age&quot; : 38 &#125; --&gt;&gt; &#123; &quot;age&quot; : 54 &#125; on : shard2 Timestamp(4, 5) </span><br><span class="line">                        &#123; &quot;age&quot; : 54 &#125; --&gt;&gt; &#123; &quot;age&quot; : 71 &#125; on : shard2 Timestamp(4, 6) </span><br><span class="line">                        &#123; &quot;age&quot; : 71 &#125; --&gt;&gt; &#123; &quot;age&quot; : 77 &#125; on : shard2 Timestamp(4, 7) </span><br><span class="line">                        &#123; &quot;age&quot; : 77 &#125; --&gt;&gt; &#123; &quot;age&quot; : 92 &#125; on : shard3 Timestamp(4, 1) </span><br><span class="line">                        &#123; &quot;age&quot; : 92 &#125; --&gt;&gt; &#123; &quot;age&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : shard3 Timestamp(2, 1) </span><br></pre></td></tr></table></figure>
<p>分片成功</p>
<h3 id="集群安全认证"><a class="markdownIt-Anchor" href="#集群安全认证"></a> 集群安全认证</h3>
<h4 id="生成密钥文件"><a class="markdownIt-Anchor" href="#生成密钥文件"></a> 生成密钥文件</h4>
<p>​     在keyfile身份验证中，副本集中的每个mongod实例都使用keyfile的内容作为共享密码，只有具有正确密钥文件的mongod或者mongos实例可以连接到副本集。密钥文件的内容必须在6到1024个字符之间，并且在unix/linux系统中文件所有者必须有对文件至少有读的权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">生成密钥文件：</span></span><br><span class="line">openssl rand -base64 756 &gt; /mongod/Tools/mongodb/KeyFile.file</span><br><span class="line">chmod 400 /mongod/Tools/mongodb/KeyFile.file</span><br><span class="line"><span class="meta">#</span><span class="bash">第一条命令是生成密钥文件，第二条命令是使用chmod更改文件权限，为文件所有者提供读权限</span></span><br></pre></td></tr></table></figure>
<h4 id="将密钥复制到集群中的每台机器"><a class="markdownIt-Anchor" href="#将密钥复制到集群中的每台机器"></a> 将密钥复制到集群中的每台机器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache05:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache06:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache07:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache08:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache09:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache10:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache11:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache12:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache13:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache14:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache15:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache16:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache17:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache18:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache19:/mongod/Tools/mongodb/</span><br><span class="line">scp /mongod/Tools/mongodb/KeyFile.file  cache20:/mongod/Tools/mongodb/</span><br><span class="line"><span class="meta">#</span><span class="bash">一定要保证密钥文件一致。文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置。</span></span><br></pre></td></tr></table></figure>
<h4 id="创建管理员账号和密码"><a class="markdownIt-Anchor" href="#创建管理员账号和密码"></a> 创建管理员账号和密码</h4>
<p><strong>账号可以在集群认开启认证以后添加。但是那时候添加比较谨慎。只能添加一次，如果忘记了就无法再连接到集群。建议在没开启集群认证的时候先添加好管理员用户名和密码然后再开启认证再重启</strong>。</p>
<p><strong>通常情况下，需要为集群添加用户，但是有些特殊情况需要对单个分片进行维护操作，所以我们需要创建但分片上的用户（Shard-local users，你不能通过mongos 进行连接。</strong></p>
<blockquote>
<hr />
<p>Read：允许用户读取指定数据库<br />
readWrite：允许用户读写指定数据库<br />
dbAdmin：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile<br />
userAdmin：允许用户向system.users集合写入，可以找指定数据库里创建、删除和管理用户<br />
clusterAdmin：只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。<br />
readAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读权限<br />
readWriteAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读写权限<br />
userAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的userAdmin权限<br />
dbAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。<br />
root：只在admin数据库中可用。超级账号，超级权限</p>
</blockquote>
<p>连接单分片的主节点和任意一台机器的mongos，分别执行下面操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 分别连接:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mongod 权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27001 --host cache05</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27002 --host cache07</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27003 --host cache09</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27004 --host cache11</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27005 --host cache13</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27006 --host cache15</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27007 --host cache17</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 27008 --host cache19</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mongos 权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   mongo --port 29000 --host cache20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">注意一定要使用admin数据库</span></span><br><span class="line"><span class="meta">#</span><span class="bash">use admin</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db.createUser(&#123;user:<span class="string">&#x27;family&#x27;</span>, <span class="built_in">pwd</span>:<span class="string">&#x27;cmcc1234&#x27;</span>, roles:[&#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125;]&#125;)</span></span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash">  use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta">mongos&gt;</span><span class="bash"> db.createUser(&#123;user:<span class="string">&#x27;family&#x27;</span>, <span class="built_in">pwd</span>:<span class="string">&#x27;cmcc1234&#x27;</span>, roles:[&#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125;]&#125;)</span></span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">        &quot;user&quot; : &quot;family&quot;,</span><br><span class="line">        &quot;roles&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;role&quot; : &quot;root&quot;,</span><br><span class="line">                        &quot;db&quot; : &quot;admin&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将集群中的所有mongod和mongos全部关闭,</p>
<p>然后删除每个mongod实例存储数据存储路径下面的mongod.lock（如果后面启动不报错可以不处理）</p>
<h4 id="配置权限并且重启集群"><a class="markdownIt-Anchor" href="#配置权限并且重启集群"></a> 配置权限并且重启集群</h4>
<p>依次在每台机器上的mongod**（注意是所有的mongod不是mongos）**的配置文件中加入下面一段配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">/mongod/Tools/mongodb/KeyFile.file</span></span><br><span class="line">  <span class="attr">authorization:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure>
<p>依次在每台机器上的mongos配置文件中加入下面一段配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">/mongod/Tools/mongodb/KeyFile.file</span></span><br></pre></td></tr></table></figure>
<p>重启集群</p>
<h3 id="集群管理"><a class="markdownIt-Anchor" href="#集群管理"></a> 集群管理</h3>
<blockquote>
<p>为了方便集群的管理，减少维护集群的复杂性，使用脚本来对集群统一操作。<br />
<strong>但是脚本不能检测到所有的异常情况，请注意脚本的打印信息，如果异常，请手动启动，并联系开发，完善脚本。</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">********************************************************************</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Author:                jingshuai</span></span><br><span class="line"><span class="meta">#</span><span class="bash">QQ：                   315134590</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Date:                  2019-09-19</span></span><br><span class="line"><span class="meta">#</span><span class="bash">URL：                  http://www.jsledd.cn</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Description：          The mongod script</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Copyright (C)：        cmri family</span></span><br><span class="line"><span class="meta">#</span><span class="bash">********************************************************************</span></span><br><span class="line">MONGODB_HOME=&quot;/mongod/Tools/mongodb/&quot;</span><br><span class="line">MONGODB_LOG_PATH=&quot;$&#123;MONGODB_HOME&#125;/log&quot;</span><br><span class="line">MONGODB_BIN_PATH=&quot;$&#123;MONGODB_HOME&#125;/bin&quot;</span><br><span class="line">MONGODB_CONF_PATH=&quot;$&#123;MONGODB_HOME&#125;/conf&quot;</span><br><span class="line">MONGODB_DATA_PATH=&quot;/data/mongodata&quot;</span><br><span class="line">MONGODB_CONF_FILE=&quot;$&#123;MONGODB_CONF_PATH&#125;/configsvr.conf&quot;</span><br><span class="line">MONGODB_CONFIGPID=&quot;$&#123;MONGODB_LOG&#125;/configsrv.pid&quot;</span><br><span class="line">MONGODB_MONGOSPID=&quot;$&#123;MONGODB_LOG&#125;/mongos.pid&quot;</span><br><span class="line">MONGODB_CONFIGHOSTS=(&quot;cache06&quot; &quot;cache08&quot; &quot;cache10&quot;)</span><br><span class="line">MONGODB_MONGOSHOSTS=(&quot;cache12&quot; &quot;cache14&quot; &quot;cache16&quot; &quot;cache18&quot; &quot;cache20&quot;)</span><br><span class="line">declare -A MONGODB_SHARDHOSTS=()</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard1&quot;]=&quot;cache05,cache06,cache08&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard2&quot;]=&quot;cache07,cache08,cache06&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard3&quot;]=&quot;cache09,cache10,cache12&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard4&quot;]=&quot;cache11,cache12,cache10&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard5&quot;]=&quot;cache13,cache14,cache16&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard6&quot;]=&quot;cache15,cache16,cache14&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard7&quot;]=&quot;cache17,cache18,cache20&quot;</span><br><span class="line">MONGODB_SHARDHOSTS[&quot;shard8&quot;]=&quot;cache19,cache20,cache18&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line">process_check()&#123;</span><br><span class="line">  host=$1</span><br><span class="line">  pidfile=$2</span><br><span class="line">  serverid=$3</span><br><span class="line">  servername=$4</span><br><span class="line">  if ssh $host test -e $pidfile;then</span><br><span class="line">    PSID=`ssh $host &quot;ps -ef | grep $(cat $pidfile)| grep -v grep&quot;`</span><br><span class="line">    echo &quot;查询host:$host 上的服务:$servername:$serverid&quot;</span><br><span class="line">    [ -n &quot;$PSID&quot; ] &amp;&amp; echo &quot;--------------------\n$&#123;PSID&#125;\n--------------------&quot; || echo &quot;$servername 进程ID:`ssh $host cat $pidfile` 不存在&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;找不到服务:$servername:$serverid，请手动检查。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line">process_stop()&#123;</span><br><span class="line">  host=$1</span><br><span class="line">  pidfile=$2</span><br><span class="line">  rmfiles=$3</span><br><span class="line">  serverid=$4</span><br><span class="line">  servername=$5</span><br><span class="line">  echo &quot;==========服务停止：$servername($serverid)开始启动==========&quot;</span><br><span class="line">    if ssh $host test -e $pidfile;then</span><br><span class="line">      ssh $host &quot;kill -2 $pidfile&quot; &amp;&amp; [ -n &quot;$rmfiles&quot; ] &amp;&amp; ssh $host &quot;rm -f $rmfiles&quot;</span><br><span class="line">    else</span><br><span class="line">      echo &quot;找不到服务:$servername:$serverid，请手动检查。&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">process_start()&#123;</span><br><span class="line">  host=$1</span><br><span class="line">  process_cmd=$2</span><br><span class="line">  process_conf=$3</span><br><span class="line">  serverid=$4</span><br><span class="line">  servername=$5</span><br><span class="line">  echo &quot;==========服务启动：$servername($serverid)开始启动==========&quot;</span><br><span class="line">  ssh host &quot;$process_cmd -f $process_conf&quot;</span><br><span class="line">&#125;</span><br><span class="line">MGDB_START()&#123;</span><br><span class="line">  echo &quot;--------------------服务启动-------------------&quot;</span><br><span class="line">  echo -e &quot;\033 ----------------configServer---------------- \033[0m&quot;</span><br><span class="line">  for confighost in $&#123;MONGODB_CONFIGHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_start $confighost $MONGODB_BIN_PATH/bin/mongod $MONGODB_CONF_FILE &quot;configsrv&quot; &quot;配置服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------mongosServer---------------- \033[0m&quot;</span><br><span class="line">  for mongoshost in $&#123;MONGODB_MONGOSHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_start $confighost $MONGODB_BIN_PATH/bin/mongos $MONGODB_CONF_FILE &quot;mongos&quot; &quot;路由服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------shardsServer---------------- \033[0m&quot;</span><br><span class="line">  for key in $&#123;!MONGODB_SHARDHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    shardarray=($&#123;MONGODB_SHARDHOSTS[$key]//,/ &#125;)</span><br><span class="line">    shardpid=&quot;$MONGODB_LOG_PATH/$key.pid&quot;</span><br><span class="line">    for shardhost in $&#123;shardarray[@]&#125;;</span><br><span class="line">    do</span><br><span class="line">      echo &quot;================$key====================&quot;</span><br><span class="line">      process_start $confighost $MONGODB_BIN_PATH/bin/mongos $MONGODB_CONF_FILE &quot;分片数据服务&quot;</span><br><span class="line">      echo &quot;==========================================&quot;</span><br><span class="line">    done</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line">MGDB_STOP()&#123;</span><br><span class="line">  echo &quot;--------------------服务停止-------------------&quot;</span><br><span class="line">  echo -e &quot;\033 ----------------mongosServer---------------- \033[0m&quot;</span><br><span class="line">  for mongoshost in $&#123;MONGODB_MONGOSHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_stop $mongoshost $MONGODB_MONGOSPID &quot;&quot; &quot;mongos&quot; &quot;路由服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------configServer---------------- \033[0m&quot;</span><br><span class="line">  for confighost in $&#123;MONGODB_CONFIGHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_stop $confighost $MONGODB_CONFIGPID &quot;$MONGODB_DATA_PATH/configsrv/mongod.lock&quot; &quot;configsrv&quot; &quot;配置服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------shardsServer---------------- \033[0m&quot;</span><br><span class="line">  for key in $&#123;!MONGODB_SHARDHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    shardarray=($&#123;MONGODB_SHARDHOSTS[$key]//,/ &#125;)</span><br><span class="line">    shardpid=&quot;$MONGODB_LOG_PATH/$key.pid&quot;</span><br><span class="line">    for shardhost in $&#123;shardarray[@]&#125;;</span><br><span class="line">    do</span><br><span class="line">      echo &quot;================$key====================&quot;</span><br><span class="line">      process_stop $shardhost $shardpid &quot;$MONGODB_DATA_PATH/$key/mongod.lock&quot; $key &quot;分片数据服务&quot;</span><br><span class="line">      echo &quot;==========================================&quot;</span><br><span class="line">    done</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MGDB_STATUS()&#123;</span><br><span class="line">  echo &quot;--------------------状态查询-------------------&quot;</span><br><span class="line">  echo -e &quot;\033 ----------------configServer---------------- \033[0m&quot;</span><br><span class="line">  for confighost in $&#123;MONGODB_CONFIGHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_check $confighost $MONGODB_CONFIGPID &quot;configsrv&quot; &quot;配置服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------mongosServer---------------- \033[0m&quot;</span><br><span class="line">  for mongoshost in $&#123;MONGODB_MONGOSHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    process_check $mongoshost $MONGODB_MONGOSPID &quot;mongos&quot; &quot;路由服务&quot;</span><br><span class="line">  done</span><br><span class="line">  echo -e &quot;\033 ----------------shardsServer---------------- \033[0m&quot;</span><br><span class="line">  for key in $&#123;!MONGODB_SHARDHOSTS[@]&#125;;</span><br><span class="line">  do</span><br><span class="line">    shardarray=($&#123;MONGODB_SHARDHOSTS[$key]//,/ &#125;)</span><br><span class="line">    shardpid=&quot;$MONGODB_LOG_PATH/$key.pid&quot;</span><br><span class="line">    for shardhost in $&#123;shardarray[@]&#125;;</span><br><span class="line">    do</span><br><span class="line">      echo &quot;================$key====================&quot;</span><br><span class="line">      process_check $shardhost $shardpid $key &quot;分片数据服务&quot;</span><br><span class="line">      echo &quot;==========================================&quot;</span><br><span class="line">    done</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in </span><br><span class="line">        start)</span><br><span class="line">                MGDB_START</span><br><span class="line">                ;;</span><br><span class="line">        stop)</span><br><span class="line">                MGDB_STOP</span><br><span class="line">                ;;</span><br><span class="line">        status)</span><br><span class="line">                MGDB_STATUS</span><br><span class="line">                ;;</span><br><span class="line">        restart)</span><br><span class="line">                MGDB_STOP</span><br><span class="line">                MGDB_START</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo $&quot;Usage: $0 &#123; start | stop | status | restart &#125;&quot;</span><br><span class="line">                exit 1</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">景帅</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.jsledd.cn/2019/09/29/mongodb42-shard/">http://www.jsledd.cn/2019/09/29/mongodb42-shard/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.jsledd.cn" target="_blank">DIUDIU 小菜鸟</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mongo/">mongo</a><a class="post-meta__tags" href="/tags/shard/">shard</a></div><div class="post_share"><div class="social-share" data-image="/images/11.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/05/largegroup/"><img class="prev-cover" src="/2021/01/05/largegroup/largegroup.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">较大分组的位置</div></div></a></div><div class="next-post pull-right"><a href="/2019/04/05/datasourcev2/"><img class="next-cover" src="/images/6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spark SQL DataSource V2 学习入门 + 代码模板</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2017/03/06/mongodb3-2-12-share/" title="Mongodb3.2.12 副本集 + 分片 完整安装"><img class="cover" src="/images/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-03-06</div><div class="title">Mongodb3.2.12 副本集 + 分片 完整安装</div></div></a></div><div><a href="/2016/05/03/mongodb-install-1/" title="mongodb 安装使用-安装和卸载-1"><img class="cover" src="/images/4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-05-03</div><div class="title">mongodb 安装使用-安装和卸载-1</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">景帅</div><div class="author-info__description">DIUDIU 小菜鸟 学习笔记</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/shadowagnoy"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/shadowagnoy/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:jingshuai@jsledd.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">记录成长</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text"> 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">2.</span> <span class="toc-text"> 创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86"><span class="toc-number">3.</span> <span class="toc-text"> 免密登陆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mongodb%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text"> MongoDB安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%92%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text"> 规划目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text"> 集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#config-server%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.1.</span> <span class="toc-text"> config server配置服务器（副本集）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shard-server%E5%88%86%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.</span> <span class="toc-text"> shard server分片服务器（副本集）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard1%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.1.</span> <span class="toc-text"> 配置shard1副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard2%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.2.</span> <span class="toc-text"> 配置shard2副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard3%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.3.</span> <span class="toc-text"> 配置shard3副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard4%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.4.</span> <span class="toc-text"> 配置shard4副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.5.</span> <span class="toc-text"> 配置shard5副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard6%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.6.</span> <span class="toc-text"> 配置shard6副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard7%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.7.</span> <span class="toc-text"> 配置shard7副本集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEshard8%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">6.2.8.</span> <span class="toc-text"> 配置shard8副本集</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mongos-server%E8%B7%AF%E7%94%B1%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.3.</span> <span class="toc-text"> mongos server路由服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%88%86%E7%89%87"><span class="toc-number">6.4.</span> <span class="toc-text"> 启用分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E7%89%87"><span class="toc-number">6.5.</span> <span class="toc-text"> 测试分片</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">7.</span> <span class="toc-text"> 集群安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text"> 生成密钥文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%AF%86%E9%92%A5%E5%A4%8D%E5%88%B6%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E6%AF%8F%E5%8F%B0%E6%9C%BA%E5%99%A8"><span class="toc-number">7.2.</span> <span class="toc-text"> 将密钥复制到集群中的每台机器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-number">7.3.</span> <span class="toc-text"> 创建管理员账号和密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9D%83%E9%99%90%E5%B9%B6%E4%B8%94%E9%87%8D%E5%90%AF%E9%9B%86%E7%BE%A4"><span class="toc-number">7.4.</span> <span class="toc-text"> 配置权限并且重启集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text"> 集群管理</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/05/largegroup/" title="较大分组的位置"><img src="/2021/01/05/largegroup/largegroup.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="较大分组的位置"/></a><div class="content"><a class="title" href="/2021/01/05/largegroup/" title="较大分组的位置">较大分组的位置</a><time datetime="2021-01-05T02:55:40.000Z" title="发表于 2021-01-05 10:55:40">2021-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/09/29/mongodb42-shard/" title="Mongodb4.2.0 副本集 + 分片 + 自动运维脚本"><img src="/images/11.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mongodb4.2.0 副本集 + 分片 + 自动运维脚本"/></a><div class="content"><a class="title" href="/2019/09/29/mongodb42-shard/" title="Mongodb4.2.0 副本集 + 分片 + 自动运维脚本">Mongodb4.2.0 副本集 + 分片 + 自动运维脚本</a><time datetime="2019-09-29T07:46:25.000Z" title="发表于 2019-09-29 15:46:25">2019-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/04/05/datasourcev2/" title="Spark SQL DataSource V2 学习入门 + 代码模板"><img src="/images/6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark SQL DataSource V2 学习入门 + 代码模板"/></a><div class="content"><a class="title" href="/2019/04/05/datasourcev2/" title="Spark SQL DataSource V2 学习入门 + 代码模板">Spark SQL DataSource V2 学习入门 + 代码模板</a><time datetime="2019-04-05T08:09:19.000Z" title="发表于 2019-04-05 16:09:19">2019-04-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/04/01/sparksql24api/" title="SPARK SQL2.4 自学教程"><img src="/images/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SPARK SQL2.4 自学教程"/></a><div class="content"><a class="title" href="/2019/04/01/sparksql24api/" title="SPARK SQL2.4 自学教程">SPARK SQL2.4 自学教程</a><time datetime="2019-04-01T07:46:25.000Z" title="发表于 2019-04-01 15:46:25">2019-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/08/05/linearregression/" title="线性回归模型的推导"><img src="/images/10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="线性回归模型的推导"/></a><div class="content"><a class="title" href="/2018/08/05/linearregression/" title="线性回归模型的推导">线性回归模型的推导</a><time datetime="2018-08-05T02:40:11.000Z" title="发表于 2018-08-05 10:40:11">2018-08-05</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/images/11.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2021 By 景帅</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a rel="nofollow" target="_blank" href="http://www.jsledd.cn/">DIUDIU小菜鸟主站：www.jsledd.cn</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: '6yuSDkPBguVOpM4aUQdtT8Lq-gzGzoHsz',
      appKey: '6U7kanDIFbCgrVL7XtRaaNLV',
      placeholder: '留下您的足迹',
      avatar: 'robohash',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>